<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Kakao Roadview - Multi-Direction</title>
    <style>
        * { margin: 0; padding: 0; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        #roadview { width: 100%; height: 100%; }
        #status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            z-index: 1000;
            white-space: pre-line;
        }
    </style>
</head>
<body>
    <div id="status">Loading...</div>
    <div id="roadview"></div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{KAKAO_API_KEY}}"></script>
    <script>
        // 샘플 좌표 (로드뷰 찾을 위치 - 공원 중심에서 N미터 떨어진 곳)
        const sampleLat = {{SAMPLE_LAT}};
        const sampleLng = {{SAMPLE_LNG}};

        // 타겟 좌표 (카메라가 볼 방향 - 공원 중심)
        const targetLat = {{TARGET_LAT}};
        const targetLng = {{TARGET_LNG}};

        // 검색 반경 (미터)
        const searchRadius = {{SEARCH_RADIUS}};

        const status = document.getElementById('status');
        status.textContent = `샘플: ${sampleLat}, ${sampleLng}\n타겟: ${targetLat}, ${targetLng}`;

        // 로드뷰 컨테이너
        const roadviewContainer = document.getElementById('roadview');

        // 로드뷰 객체 생성
        const roadview = new kakao.maps.Roadview(roadviewContainer);

        // 로드뷰 클라이언트 생성 (파노라마 ID 검색용)
        const roadviewClient = new kakao.maps.RoadviewClient();

        // 샘플 좌표 객체 생성 (로드뷰 검색용)
        const samplePosition = new kakao.maps.LatLng(sampleLat, sampleLng);

        // Bearing(방위각) 계산 함수
        function calculateBearing(lat1, lng1, lat2, lng2) {
            const toRadians = (deg) => deg * Math.PI / 180;
            const toDegrees = (rad) => rad * 180 / Math.PI;

            const dLng = toRadians(lng2 - lng1);
            const lat1Rad = toRadians(lat1);
            const lat2Rad = toRadians(lat2);

            const y = Math.sin(dLng) * Math.cos(lat2Rad);
            const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) -
                      Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLng);

            let bearing = toDegrees(Math.atan2(y, x));

            // 0-360 범위로 정규화
            bearing = (bearing + 360) % 360;

            return bearing;
        }

        // 샘플 좌표 주변에서 로드뷰 정보 가져오기
        roadviewClient.getNearestPanoId(samplePosition, searchRadius, function(panoId) {
            if (panoId === null) {
                status.textContent = '로드뷰를 표시할 수 없습니다';
                status.style.background = 'rgba(255,0,0,0.7)';
                document.body.classList.add('roadview-error');
            } else {
                // 로드뷰 초기화 이벤트 리스너 등록
                kakao.maps.event.addListener(roadview, 'init', function() {
                    // 로드뷰 위치 정보 가져오기 (완전히 로드된 후)
                    const position = roadview.getPosition();
                    const cameraLat = position.getLat();
                    const cameraLng = position.getLng();

                    // 카메라 → 타겟 방향 계산 (공원 중심을 향하도록)
                    const bearing = calculateBearing(cameraLat, cameraLng, targetLat, targetLng);

                    // 방향 설정 (자동으로 공원 중심을 향하도록)
                    roadview.setViewpoint({
                        pan: bearing,  // 계산된 방위각
                        tilt: 0,       // 수평 (0도)
                        zoom: 0        // 기본 줌
                    });

                    // 추가 로딩 대기 시간 (이미지가 완전히 렌더링될 때까지)
                    setTimeout(function() {
                        status.textContent =
                        `로드뷰 로드 완료\n` +
                        `Pano ID: ${panoId}\n` +
                        `카메라: ${cameraLat.toFixed(6)}, ${cameraLng.toFixed(6)}\n` +
                        `타겟: ${targetLat}, ${targetLng}\n` +
                        `방향: ${bearing.toFixed(1)}°`;
                        status.style.background = 'rgba(0,255,0,0.7)';

                        // 로드 완료 표시
                        document.body.classList.add('roadview-loaded');
                    }, 2000);  // 2초 추가 대기 (이미지 완전 로딩)
                });

                // 로드뷰 표시 (샘플 위치 기준)
                roadview.setPanoId(panoId, samplePosition);
            }
        });
    </script>
</body>
</html>
