<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Kakao Roadview</title>
    <style>
        * { margin: 0; padding: 0; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        #roadview { width: 100%; height: 100%; }
        #status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            z-index: 1000;
            white-space: pre-line;
        }
    </style>
</head>
<body>
    <div id="status">Loading...</div>
    <div id="roadview"></div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{KAKAO_API_KEY}}"></script>
    <script>
        // 타겟 좌표 (건물 위치 - 내가 보고 싶은 곳)
        const targetLat = {{LATITUDE}};
        const targetLng = {{LONGITUDE}};

        const status = document.getElementById('status');
        status.textContent = `타겟 위치: ${targetLat}, ${targetLng}`;

        // 로드뷰 컨테이너
        const roadviewContainer = document.getElementById('roadview');

        // 로드뷰 객체 생성
        const roadview = new kakao.maps.Roadview(roadviewContainer);

        // 로드뷰 클라이언트 생성 (파노라마 ID 검색용)
        const roadviewClient = new kakao.maps.RoadviewClient();

        // 타겟 좌표 객체 생성
        const targetPosition = new kakao.maps.LatLng(targetLat, targetLng);

        // Bearing(방위각) 계산 함수
        function calculateBearing(lat1, lng1, lat2, lng2) {
            const toRadians = (deg) => deg * Math.PI / 180;
            const toDegrees = (rad) => rad * 180 / Math.PI;

            const dLng = toRadians(lng2 - lng1);
            const lat1Rad = toRadians(lat1);
            const lat2Rad = toRadians(lat2);

            const y = Math.sin(dLng) * Math.cos(lat2Rad);
            const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) -
                      Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLng);

            let bearing = toDegrees(Math.atan2(y, x));

            // 0-360 범위로 정규화
            bearing = (bearing + 360) % 360;

            return bearing;
        }

        // 해당 좌표의 로드뷰 정보 가져오기
        roadviewClient.getNearestPanoId(targetPosition, 50, function(panoId) {
            if (panoId === null) {
                status.textContent = '로드뷰를 표시할 수 없습니다';
                status.style.background = 'rgba(255,0,0,0.7)';
                document.body.classList.add('roadview-error');
            } else {
                // 로드뷰 초기화 이벤트 리스너 등록
                kakao.maps.event.addListener(roadview, 'init', function() {
                    // 로드뷰 위치 정보 가져오기 (완전히 로드된 후)
                    const position = roadview.getPosition();
                    const cameraLat = position.getLat();
                    const cameraLng = position.getLng();

                    // 카메라 → 타겟 방향 계산
                    const bearing = calculateBearing(cameraLat, cameraLng, targetLat, targetLng);

                    // 방향 설정 (자동으로 건물을 향하도록)
                    roadview.setViewpoint({
                        pan: bearing,  // 계산된 방위각
                        tilt: 0,       // 수평 (0도)
                        zoom: 0        // 기본 줌
                    });

                    status.textContent =
                        `로드뷰 로드 완료\n` +
                        `Pano ID: ${panoId}\n` +
                        `카메라: ${cameraLat.toFixed(6)}, ${cameraLng.toFixed(6)}\n` +
                        `타겟: ${targetLat}, ${targetLng}\n` +
                        `방향: ${bearing.toFixed(1)}°`;
                    status.style.background = 'rgba(0,255,0,0.7)';

                    // 로드 완료 표시
                    document.body.classList.add('roadview-loaded');
                });

                // 로드뷰 표시
                roadview.setPanoId(panoId, targetPosition);
            }
        });
    </script>
</body>
</html>
